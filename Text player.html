<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGV QA Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --player-bg: #1a1a1a;
            --control-color: #fff;
            --highlight-color: #f00;
        }

        body {
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .player-container {
            width: 100%;
            max-width: 900px;
            margin: auto;
            background-color: var(--player-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            padding: 1rem;
            position: relative;
        }
        
        .player-window {
            background-color: #000;
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            border-radius: 8px;
            overflow: hidden;
        }

        .timer {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 4px;
            z-index: 2;
        }

        .question-id-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #87ceeb; /* sky-blue */
            color: #000;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            z-index: 2;
            display: none; /* Hidden by default */
        }

        #countdown-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: bold;
            z-index: 3;
            display: none; /* Hidden by default */
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
        }

        .qa-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            color: var(--control-color);
            font-size: 1.1rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            text-align: center;
            padding: 0 1rem;
            white-space: pre-wrap;
            transition: font-size 0.3s ease;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0 1rem;
        }

        .progress-bar-container {
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--highlight-color);
            transition: width 0.3s ease-in-out;
        }

        .control-button {
            background: none;
            border: none;
            color: var(--control-color);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .control-button:hover {
            color: var(--highlight-color);
        }

        .language-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--control-color);
        }

        .file-upload-container {
            margin-top: 1rem;
        }

        .custom-control-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #2b2b2b;
            border-radius: 8px;
        }

        .custom-control-panel .btn {
            font-size: 0.75rem;
            padding: 0.1rem 0.5rem;
            line-height: 1.5;
        }

        .custom-control-panel .text-sm {
            font-size: 0.75rem;
        }

        .control-group:first-child {
            margin-right: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .qa-text {
                font-size: 1.5rem;
                padding: 0 2rem;
            }
        }
        
        .player-branding {
            position: absolute;
            bottom: 0.5rem;
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 0.25rem;
            padding: 0.25rem 0.2rem;
            background-color: rgba(0, 0, 150, 0.9);
            color: #fff;
            border-radius: 10px;
        }
    </style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center min-vh-100">

    <div class="player-container">
        <div class="player-window">
            <span class="timer" id="timer-display">00:00</span>
            <span class="question-id-badge" id="question-id-display"></span>
            <div id="countdown-display"></div>
            <h1 class="qa-text" id="qa-display">Upload a Q&A file to begin</h1>
            <span class="player-branding">SGV TEXT PLAYER</span>
        </div>

        <div class="progress-bar-container mt-3">
            <div class="progress-bar-fill" id="playback-progress" style="width: 0%;"></div>
        </div>
        
        <div class="player-controls">
            <button class="control-button" id="prev-btn">
                <i class="bi bi-skip-backward-fill"></i>
            </button>
            <button class="control-button" id="play-pause-btn">
                <i class="bi bi-play-fill"></i>
            </button>
            <button class="control-button" id="next-btn">
                <i class="bi bi-skip-forward-fill"></i>
            </button>
            <div class="language-controls ms-auto">
                <label for="language-select" class="form-label mb-0 me-2">Language:</label>
                <select class="form-select form-select-sm" id="language-select"></select>
            </div>
        </div>

        <div class="custom-control-panel">
            <div class="d-flex align-items-center control-group">
                <span class="text-white-50 text-sm">Delay: <span id="delay-value">3</span>s</span>
                <button class="btn btn-sm btn-secondary ms-2" id="delay-minus-btn">-</button>
                <button class="btn btn-sm btn-secondary ms-2" id="delay-plus-btn">+</button>
            </div>
            <div class="d-flex align-items-center control-group">
                <span class="text-white-50 text-sm">Font Size:</span>
                <button class="btn btn-sm btn-secondary ms-2" id="font-minus-btn">-</button>
                <button class="btn btn-sm btn-secondary ms-2" id="font-plus-btn">+</button>
            </div>
        </div>
        <div class="file-upload-container">
            <label for="qa-file" class="form-label text-white-50">Upload a Q&A (.txt) file:</label>
            <input class="form-control form-control-sm" id="qa-file" type="file" accept=".txt">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <script>
        const qaFile = document.getElementById('qa-file');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const languageSelect = document.getElementById('language-select');
        const qaDisplay = document.getElementById('qa-display');
        const progressBarFill = document.getElementById('playback-progress');
        const timerDisplay = document.getElementById('timer-display');
        
        const delayMinusBtn = document.getElementById('delay-minus-btn');
        const delayPlusBtn = document.getElementById('delay-plus-btn');
        const delayValueDisplay = document.getElementById('delay-value');
        const fontMinusBtn = document.getElementById('font-minus-btn');
        const fontPlusBtn = document.getElementById('font-plus-btn');

        const questionIdDisplay = document.getElementById('question-id-display');
        const countdownDisplay = document.getElementById('countdown-display');

        let qaItems = [];
        let currentItemIndex = -1;
        let isPlaying = false;
        let synth = window.speechSynthesis;
        let currentUtterance = null;
        let typingInterval = null;
        let countdownInterval = null;
        
        let timerInterval = null;
        let startTime = 0;
        let pausedTime = 0;

        let delayBetweenItems = 3; 
        let currentFontSizeRem = 1.1;
        const FONT_SIZE_STEP = 0.1;
        const FONT_SIZE_MIN = 0.8;
        const FONT_SIZE_MAX = 2.5;

        let typingCurrentIndex = 0;
        let typingFullText = '';
        
        if (window.innerWidth >= 768) {
            currentFontSizeRem = 1.5;
        }
        qaDisplay.style.fontSize = `${currentFontSizeRem}rem`;

        const allLanguages = {
            'none': 'No Translation', 'af': 'Afrikaans', 'sq': 'Albanian', 'am': 'Amharic', 'ar': 'Arabic', 'hy': 'Armenian',
            'az': 'Azerbaijani', 'eu': 'Basque', 'be': 'Belarusian', 'bn': 'Bengali', 'bs': 'Bosnian',
            'bg': 'Bulgarian', 'ca': 'Catalan', 'ceb': 'Cebuano', 'ny': 'Chichewa', 'zh-CN': 'Chinese (Simplified)',
            'zh-TW': 'Chinese (Traditional)', 'co': 'Corsican', 'hr': 'Croatian', 'cs': 'Czech', 'da': 'Danish',
            'nl': 'Dutch', 'en': 'English', 'en-IN': 'English (India)', 'eo': 'Esperanto', 'et': 'Estonian', 'tl': 'Filipino',
            'fi': 'Finnish', 'fr': 'French', 'fy': 'Frisian', 'gl': 'Galician', 'ka': 'Georgian',
            'de': 'German', 'el': 'Greek', 'gu': 'Gujarati', 'ht': 'Haitian Creole', 'ha': 'Hausa',
            'haw': 'Hawaiian', 'iw': 'Hebrew', 'hi': 'Hindi', 'hmn': 'Hmong', 'hu': 'Hungarian',
            'is': 'Icelandic', 'ig': 'Igbo', 'id': 'Indonesian', 'ga': 'Irish', 'it': 'Italian',
            'ja': 'Japanese', 'jw': 'Javanese', 'kn': 'Kannada', 'kk': 'Kazakh', 'km': 'Khmer',
            'ko': 'Korean', 'ku': 'Kurdish (Kurmanji)', 'ky': 'Kyrgyz', 'lo': 'Lao', 'la': 'Latin',
            'lv': 'Latvian', 'lt': 'Lithuanian', 'lb': 'Luxembourgish', 'mk': 'Macedonian', 'mg': 'Malagasy',
            'ms': 'Malay', 'ml': 'Malayalam', 'mt': 'Maltese', 'mi': 'Maori', 'mr': 'Marathi',
            'mn': 'Mongolian', 'my': 'Myanmar (Burmese)', 'ne': 'Nepali', 'no': 'Norwegian', 'or': 'Odia', 'ps': 'Pashto',
            'fa': 'Persian', 'pl': 'Polish', 'pt': 'Portuguese', 'pa': 'Punjabi', 'ro': 'Romanian',
            'ru': 'Russian', 'sm': 'Samoan', 'gd': 'Scots Gaelic', 'sr': 'Serbian', 'st': 'Sesotho',
            'sn': 'Shona', 'sd': 'Sindhi', 'si': 'Sinhala', 'sk': 'Slovak', 'sl': 'Slovenian',
            'so': 'Somali', 'es': 'Spanish', 'su': 'Sundanese', 'sw': 'Swahili', 'sv': 'Swedish',
            'tg': 'Tajik', 'ta': 'Tamil', 'te': 'Telugu', 'th': 'Thai', 'tr': 'Turkish',
            'uk': 'Ukrainian', 'ur': 'Urdu', 'uz': 'Uzbek', 'vi': 'Vietnamese', 'cy': 'Welsh',
            'xh': 'Xhosa', 'yi': 'Yiddish', 'yo': 'Yoruba', 'zu': 'Zulu'
        };

        const typeText = (element, text) => {
            typingFullText = text;
            typingCurrentIndex = 0;
            element.textContent = '';
            const typingSpeed = 50; 
            if (typingInterval) clearInterval(typingInterval);
            typingInterval = setInterval(() => {
                if (typingCurrentIndex < typingFullText.length) {
                    element.textContent += typingFullText.charAt(typingCurrentIndex);
                    typingCurrentIndex++;
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                }
            }, typingSpeed);
        };
        
        const parseQAFile = (text) => {
            try {
                const data = JSON.parse(text);
                return data.questions.map(item => ({
                    question: item.question,
                    answer: item.answer
                }));
            } catch (e) {
                console.error("Error parsing JSON file:", e);
                return [];
            }
        };
        
        const translateText = async (text, targetLang) => {
            if (targetLang === 'en' || targetLang === 'en-IN' || targetLang === 'none') return text;
            try {
                const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`);
                const data = await response.json();
                return data[0].map(item => item[0]).join('');
            } catch (error) {
                console.error('Translation error:', error);
                return text;
            }
        };

        const speakText = (text, lang, onEndCallback) => {
            if (currentUtterance) {
                synth.cancel();
            }
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = lang;
            currentUtterance.onend = () => {
                currentUtterance = null;
                if (onEndCallback) onEndCallback();
            };
            synth.speak(currentUtterance);
        };
        
        // *** MODIFIED FUNCTION ***
        const showAnswer = async () => {
            if (!isPlaying || currentItemIndex < 0) return;
            
            // New logic to determine the delay before the next question
            let delayAfterAnswer = (delayBetweenItems > 5) ? 3 : delayBetweenItems;

            const item = qaItems[currentItemIndex];
            const targetLang = languageSelect.value;
            const translatedAnswer = await translateText(item.answer, targetLang);
            typeText(qaDisplay, translatedAnswer);

            if (targetLang !== 'none') {
                speakText(translatedAnswer, targetLang, () => {
                    if (isPlaying) setTimeout(playNextItem, delayAfterAnswer * 1000);
                });
            } else {
                setTimeout(() => {
                    if (isPlaying) playNextItem();
                }, delayAfterAnswer * 1000);
            }
        };

        const handlePostQuestionDelay = () => {
            if (countdownInterval) clearInterval(countdownInterval);
            // The delay between Q and A still uses the main 'delayBetweenItems'
            if (isPlaying && delayBetweenItems > 3 && languageSelect.value !== 'none') {
                let countdown = delayBetweenItems;
                countdownDisplay.textContent = countdown;
                countdownDisplay.style.display = 'block';
                qaDisplay.style.visibility = 'hidden';
                countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        countdownDisplay.textContent = countdown;
                    } else {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                        countdownDisplay.style.display = 'none';
                        qaDisplay.style.visibility = 'visible';
                        showAnswer();
                    }
                }, 1000);
            } else {
                setTimeout(() => {
                    if (isPlaying) showAnswer();
                }, delayBetweenItems * 1000);
            }
        };

        const speakQA = async (item) => {
            if (!item) return;
            if (countdownInterval) clearInterval(countdownInterval);
            countdownDisplay.style.display = 'none';
            qaDisplay.style.visibility = 'visible';
            const targetLang = languageSelect.value;
            const translatedQuestion = await translateText(item.question, targetLang);
            typeText(qaDisplay, translatedQuestion);
            if (targetLang !== 'none') {
                speakText(translatedQuestion, targetLang, handlePostQuestionDelay);
            } else {
                const readingTime = (translatedQuestion.length * 50) + 1000;
                setTimeout(handlePostQuestionDelay, readingTime);
            }
        };

        const updateUIForCurrentItem = () => {
            if (qaItems.length > 0 && currentItemIndex >= 0) {
                const progress = ((currentItemIndex + 1) / qaItems.length) * 100;
                progressBarFill.style.width = `${progress}%`;
                questionIdDisplay.textContent = `Q: ${currentItemIndex + 1}/${qaItems.length}`;
                questionIdDisplay.style.display = 'block';
            } else {
                progressBarFill.style.width = '0%';
                questionIdDisplay.style.display = 'none';
            }
        };
        
        const playNextItem = () => {
            stopPlayer(true); // Soft stop
            currentItemIndex++;
            if (currentItemIndex < qaItems.length) {
                speakQA(qaItems[currentItemIndex]);
                isPlaying = true;
            } else {
                stopPlayer();
            }
            updateUIForCurrentItem();
            updatePlayButton();
        };

        const playPreviousItem = () => {
            stopPlayer(true); // Soft stop
            currentItemIndex = Math.max(0, currentItemIndex - 1);
            if (currentItemIndex >= 0) {
                speakQA(qaItems[currentItemIndex]);
                isPlaying = true;
            } else {
                stopPlayer();
            }
            updateUIForCurrentItem();
            updatePlayButton();
        };
        
        const playPause = () => {
            if (!qaItems.length) return;
            if (isPlaying) {
                synth.pause();
                pauseTimer();
                if (typingInterval) clearInterval(typingInterval);
                if (countdownInterval) clearInterval(countdownInterval);
                isPlaying = false;
            } else {
                isPlaying = true;
                if (synth.paused) {
                    synth.resume();
                    startTimer(); 
                } else {
                    playPreviousItem(); 
                }
            }
            updatePlayButton();
        };
        
        const updatePlayButton = () => {
            playPauseBtn.querySelector('i').className = isPlaying ? 'bi bi-pause-fill' : 'bi bi-play-fill';
        };

        const stopPlayer = (isSoftStop = false) => {
            synth.cancel();
            if (typingInterval) clearInterval(typingInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            typingInterval = null;
            countdownInterval = null;
            isPlaying = false;
            if (!isSoftStop) {
                if (!qaItems.length) {
                    currentItemIndex = -1;
                    qaDisplay.textContent = 'Upload a Q&A file to begin.';
                  updateUIForCurrentItem();
                } else {
                    qaDisplay.textContent = qaItems[currentItemIndex] ? qaItems[currentItemIndex].question : 'End of Q&A.';
                }
            }
            updatePlayButton();
        };

        const startTimer = () => {
            if (timerInterval) clearInterval(timerInterval);
            startTime = pausedTime > 0 ? Date.now() - pausedTime : Date.now();
            timerInterval = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                const minutes = String(Math.floor(elapsedSeconds / 60)).padStart(2, '0');
                const seconds = String(elapsedSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
            }, 1000);
        };

        const pauseTimer = () => {
            if (timerInterval) {
                pausedTime = Date.now() - startTime;
                clearInterval(timerInterval);
                timerInterval = null;
            }
        };

        const resetTimer = () => {
            pauseTimer();
            startTime = 0;
            pausedTime = 0;
            timerDisplay.textContent = '00:00';
        };

        qaFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    qaItems = parseQAFile(e.target.result);
                    stopPlayer();
                    resetTimer();
                    currentItemIndex = -1;
                    if (qaItems.length > 0) {
                        playNextItem();
                        startTimer();
                    } else {
                        qaDisplay.textContent = 'No questions or answers found in file.';
                        updateUIForCurrentItem();
                    }
                };
                reader.readAsText(file);
            }
        });

        playPauseBtn.addEventListener('click', playPause);
        prevBtn.addEventListener('click', playPreviousItem);
        nextBtn.addEventListener('click', playNextItem);

        const setupLanguageOptions = () => {
            const sortedLanguages = Object.keys(allLanguages).sort((a, b) => allLanguages[a].localeCompare(allLanguages[b]));
            languageSelect.innerHTML = '';
            sortedLanguages.forEach(langCode => {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = allLanguages[langCode];
                languageSelect.appendChild(option);
            });
            const savedLang = localStorage.getItem('sgvPlayerLanguage');
            if (savedLang && allLanguages[savedLang]) {
                languageSelect.value = savedLang;
            } else {
                languageSelect.value = 'en-IN';
            }
        };

        languageSelect.addEventListener('change', () => {
            localStorage.setItem('sgvPlayerLanguage', languageSelect.value); 
            if (qaItems.length > 0 && currentItemIndex >= 0) {
                stopPlayer(true); 
                speakQA(qaItems[currentItemIndex]);
                isPlaying = true;
                updatePlayButton();
            }
        });

        delayMinusBtn.addEventListener('click', () => {
            if (delayBetweenItems > 0) {
                delayBetweenItems--;
                delayValueDisplay.textContent = delayBetweenItems;
            }
        });

        delayPlusBtn.addEventListener('click', () => {
            if (delayBetweenItems < 10) {
                delayBetweenItems++;
                delayValueDisplay.textContent = delayBetweenItems;
            }
        });

        fontMinusBtn.addEventListener('click', () => {
            if (currentFontSizeRem > FONT_SIZE_MIN) {
                currentFontSizeRem = Math.max(FONT_SIZE_MIN, currentFontSizeRem - FONT_SIZE_STEP);
                qaDisplay.style.fontSize = `${currentFontSizeRem}rem`;
            }
        });

        fontPlusBtn.addEventListener('click', () => {
            if (currentFontSizeRem < FONT_SIZE_MAX) {
                currentFontSizeRem = Math.min(FONT_SIZE_MAX, currentFontSizeRem + FONT_SIZE_STEP);
                qaDisplay.style.fontSize = `${currentFontSizeRem}rem`;
            }
        });
        
        setupLanguageOptions();
    </script>
</body>
</html>
